<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi" xml:lang="vi">

<head th:replace="~{fragments/head :: commonHead('Danh sách Yêu cầu', false)}"></head>

<body class="d-flex flex-column min-vh-100">
    <div th:insert="~{fragments/header :: header}"></div>

    <main class="container flex-grow-1 mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="mb-0">Danh sách Yêu cầu</h1>
                    <!-- Button to navigate to the request creation page -->
                    <a href="/staff/requests/create" class="btn btn-outline-success">
                        <i class="fas fa-plus me-2"></i>Thêm mới
                    </a>
                </div>

                <!-- Filter Form: Allows users to filter requests by status and search by customer name/request ID. -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form th:action="@{/staff/requests/list}" method="get" class="row g-3">
                            <!-- Status filter dropdown -->
                            <div class="col-md-3">
                                <label for="status" class="form-label">Lọc theo trạng thái</label>
                                <select name="status" id="status" class="form-select">
                                    <option value="">Tất cả</option>
                                    <!-- Iterates over RequestStatus enum values to populate options -->
                                    <option th:each="s : ${T(com.laptoprepair.enums.RequestStatus).values()}"
                                        th:value="${s.name()}" th:text="${s.getValue()}"
                                        th:selected="${status != null and status.name() == s.name()}"></option>
                                </select>
                            </div>
                            <!-- Search input for customer name, phone, serial number, or device -->
                            <div class="col-md-5">
                                <label for="search" class="form-label">Tìm kiếm</label>
                                <input type="text" name="search" id="search" class="form-control" th:value="${search}"
                                    placeholder="Tìm theo tên, SĐT, serial, thiết bị..." />
                            </div>
                            <!-- Filter and Reset buttons -->
                            <div class="col-md-4 d-flex align-items-end gap-1">
                                <button type="submit" class="btn btn-outline-primary flex-fill">
                                    <i class="fas fa-filter me-1"></i>Lọc
                                </button>
                                <a href="/staff/requests/list" class="btn btn-outline-secondary flex-fill">
                                    <i class="fas fa-redo me-1"></i>Reset
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Record Count Display: Shows the number of requests currently displayed and total requests. -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="text-muted">
                        <span th:if="${requests.totalElements > 0}">
                            Hiển thị <strong th:text="${requests.numberOfElements}"></strong>
                            trên tổng <strong th:text="${requests.totalElements}"></strong> yêu cầu sửa chữa
                        </span>
                        <span th:unless="${requests.totalElements > 0}">
                            Không có yêu cầu nào
                        </span>
                    </div>
                </div>

                <!-- Results Table: Displays the list of requests in a table format. -->
                <div class="card">
                    <div class="card-body">
                        <div th:if="${requests.hasContent()}" class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 5%">Mã</th>
                                        <th style="width: 21%">Thông tin khách hàng</th>
                                        <th style="width: 28%">Thông tin thiết bị</th>
                                        <th style="width: 11%">Thời gian</th>
                                        <th style="width: 12%">Trạng thái</th>
                                        <th style="width: 9%">Tổng tiền</th>
                                        <th style="width: 14%" class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Iterates over each request in the current page's content -->
                                    <tr th:each="request : ${requests.content}">
                                        <!-- Displays a truncated version of the request ID for brevity -->
                                        <td th:with="idStr=${request.id.toString()}">
                                            <code
                                                th:text="${'...' + #strings.substring(idStr, #strings.length(idStr) - 4)}"></code>
                                        </td>
                                        <!-- Customer Information Column -->
                                        <td>
                                            <div class="customer-info">
                                                <div class="fw-bold" th:text="${request.name}"></div>
                                                <div class="small text-muted" th:if="${request.phone}"
                                                    th:text="${request.phone}"></div>
                                                <div class="small text-muted" th:if="${request.email}"
                                                    th:text="${request.email}"></div>
                                                <div class="small text-muted" th:if="${request.address}"
                                                    th:text="${request.address}"></div>
                                            </div>
                                        </td>
                                        <!-- Device Information Column -->
                                        <td>
                                            <div class="device-info">
                                                <div class="fw-bold" th:if="${request.brandModel}"
                                                    th:text="${request.brandModel}"></div>
                                                <div class="small text-muted" th:if="${request.serialNumber}">
                                                    Serial: <span th:text="${request.serialNumber}"></span>
                                                </div>
                                                <div class="small text-muted device-description"
                                                    th:if="${request.description}" th:text="${#strings.length(request.description) > 100 ? 
                                                               #strings.substring(request.description, 0, 100) + '...' : 
                                                               request.description}"></div>
                                            </div>
                                        </td>
                                        <!-- Repair Time Column -->
                                        <td>
                                            <div class="repair-time">
                                                <div class="small">
                                                    <strong>Hẹn:</strong><br />
                                                    <span
                                                        th:text="${#temporals.format(request.appointmentDate, 'dd/MM/yyyy HH:mm')}"></span>
                                                </div>
                                                <div class="small text-muted" th:if="${request.completedAt}">
                                                    <strong>Hoàn thành:</strong><br />
                                                    <span
                                                        th:text="${#temporals.format(request.completedAt, 'dd/MM/yyyy HH:mm')}"></span>
                                                </div>
                                            </div>
                                        </td>
                                        <!-- Status Column -->
                                        <td>
                                            <span th:if="${request.status != null}"
                                                th:class="${request.status.badgeClass}"
                                                th:text="${request.status.value}"></span>
                                            <span th:unless="${request.status != null}" class="badge bg-secondary">Không
                                                xác định</span>
                                        </td>
                                        <!-- Total Amount Column -->
                                        <td>
                                            <span class="currency-format" th:data-amount="${request.getTotal()}"></span>
                                        </td>
                                        <td class="text-center">
                                            <!-- Button to view request details -->
                                            <a th:href="@{/staff/requests/view/{id}(id=${request.id})}"
                                                class="btn btn-sm btn-outline-primary me-1" title="Xem chi tiết">
                                                <i class="fas fa-eye me-1"></i>Xem
                                            </a>
                                            <!--
                                                Conditional edit button:
                                                - Shown if status is null (new request) or not CANCELLED.
                                            -->
                                            <a th:if="${request.status == null}"
                                                th:href="@{/staff/requests/edit/{id}(id=${request.id})}"
                                                class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                                <i class="fas fa-edit me-1"></i>Sửa
                                            </a>
                                            <a th:if="${request.status != null and request.status.name() != 'CANCELLED'}"
                                                th:href="@{/staff/requests/edit/{id}(id=${request.id})}"
                                                class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                                <i class="fas fa-edit me-1"></i>Sửa
                                            </a>
                                            <!--
                                                Conditional lock button:
                                                - Shown (disabled) only if status is CANCELLED.
                                            -->
                                            <button
                                                th:if="${request.status != null and request.status.name() == 'CANCELLED'}"
                                                class="btn btn-sm btn-outline-secondary" disabled title="Đã khóa">
                                                <i class="fas fa-lock me-1"></i>Khóa
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Message displayed when no requests are found -->
                        <div th:unless="${requests.hasContent()}" class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Không tìm thấy yêu cầu nào</h5>
                            <p class="text-muted">Thử thay đổi bộ lọc hoặc tìm kiếm khác.</p>
                        </div>
                    </div>
                </div>

                <!-- Pagination: Navigation for browsing through multiple pages of requests. -->
                <nav aria-label="Page navigation" th:if="${requests.totalPages > 0}" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <!-- "Previous" page link -->
                        <li class="page-item" th:classappend="${requests.number == 0} ? 'disabled'">
                            <a class="page-link"
                                th:href="@{/staff/requests/list(page=${requests.number - 1}, size=${requests.size}, status=${status != null ? status : ''}, search=${search ?: ''})}"
                                th:if="${requests.number > 0}">Trước</a>
                            <span class="page-link" th:if="${requests.number == 0}">Trước</span>
                        </li>
                        <!-- "Next" page link -->
                        <li class="page-item"
                            th:classappend="${requests.number >= requests.totalPages - 1} ? 'disabled'">
                            <a class="page-link"
                                th:href="@{/staff/requests/list(page=${requests.number + 1}, size=${requests.size}, status=${status != null ? status : ''}, search=${search ?: ''})}"
                                th:if="${requests.number < requests.totalPages - 1}">Sau</a>
                            <span class="page-link" th:if="${requests.number >= requests.totalPages - 1}">Sau</span>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </main>

    <div th:insert="~{fragments/footer :: footer}"></div>
</body>

</html>