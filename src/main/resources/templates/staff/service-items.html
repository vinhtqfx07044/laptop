<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi" xml:lang="vi">

<head th:replace="~{fragments/head :: commonHead('Quản lý Dịch vụ', false)}"></head>

<body class="d-flex flex-column min-vh-100">
    <div th:insert="~{fragments/header :: header}"></div>

    <main class="container flex-grow-1 mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="mb-0">Danh sách Dịch vụ</h1>
                    <!-- Action buttons for Import CSV, Export CSV, and Add New Service -->
                    <div class="d-flex gap-2">
                        <!-- Button to open the CSV Import modal -->
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#csvImportModal">
                            <i class="fas fa-upload me-2"></i>Import CSV
                        </button>
                        <!-- Link to export service items as CSV -->
                        <a href="/staff/service-items/export" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Export CSV
                        </a>
                        <!-- Button to add a new service item, triggers `addServiceItem()` JavaScript function -->
                        <button type="button" class="btn btn-outline-success" onclick="addServiceItem()">
                            <i class="fas fa-plus me-2"></i>Thêm mới
                        </button>
                    </div>
                </div>

                <!-- Filter Form: Allows filtering service items by active status and searching by name. -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form th:action="@{/staff/service-items}" method="get" class="row g-3">
                            <!-- Status filter dropdown (All, Active Only, Inactive Only) -->
                            <div class="col-md-3">
                                <label for="activeOnly" class="form-label">Lọc theo trạng thái</label>
                                <select name="activeOnly" id="activeOnly" class="form-select">
                                    <option value="" th:selected="${activeOnly == null}">Tất cả</option>
                                    <option value="true" th:selected="${activeOnly == true}">Chỉ hoạt động</option>
                                    <option value="false" th:selected="${activeOnly == false}">Chỉ ngừng hoạt động
                                    </option>
                                </select>
                            </div>
                            <!-- Search input for service name -->
                            <div class="col-md-5">
                                <label for="search" class="form-label">Tìm kiếm theo tên dịch vụ</label>
                                <input type="text" name="search" id="search" class="form-control" th:value="${search}"
                                    placeholder="Nhập tên dịch vụ..." />
                            </div>
                            <!-- Filter and Reset buttons -->
                            <div class="col-md-4 d-flex align-items-end gap-1">
                                <button type="submit" class="btn btn-outline-primary flex-fill">
                                    <i class="fas fa-filter me-1"></i>Lọc
                                </button>
                                <a href="/staff/service-items" class="btn btn-outline-secondary flex-fill">
                                    <i class="fas fa-redo me-1"></i>Reset
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Record Count Display: Shows the number of service items currently displayed and total items. -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="text-muted">
                        <span th:if="${serviceItems.totalElements > 0}">
                            Hiển thị <strong th:text="${serviceItems.numberOfElements}"></strong>
                            trên tổng <strong th:text="${serviceItems.totalElements}"></strong> dịch vụ
                        </span>
                        <span th:unless="${serviceItems.totalElements > 0}">
                            Không có dịch vụ nào
                        </span>
                    </div>
                </div>

                <!-- Service Items Table: Displays the list of service items. -->
                <div class="card">
                    <div class="card-body">
                        <div th:if="${serviceItems.totalElements > 0}" class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Tên dịch vụ</th>
                                        <th>Giá</th>
                                        <th>VAT (%)</th>
                                        <th>Bảo hành (ngày)</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày cập nhật</th>
                                        <th class="text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Iterates over each service item in the current page's content -->
                                    <tr th:each="item : ${serviceItems.content}" th:id="'row-' + ${item.id}">
                                        <td>
                                            <strong th:text="${item.name}"></strong>
                                        </td>
                                        <td>
                                            <!-- Displays price formatted as currency using a custom JavaScript function (currency-format) -->
                                            <span class="currency-format" th:data-amount="${item.price}"></span>
                                        </td>
                                        <!-- Displays VAT rate as a percentage, formatted to one decimal place -->
                                        <td
                                            th:text="${#numbers.formatDecimal(item.vatRate * 100, 1, 'POINT', 1, 'POINT')} + '%'">
                                        </td>
                                        <td th:text="${item.warrantyDays}"></td>
                                        <td>
                                            <!-- Displays active status as a badge with dynamic styling -->
                                            <span th:class="${item.active ? 'badge bg-success' : 'badge bg-secondary'}"
                                                th:text="${item.active ? 'Hoạt động' : 'Ngừng hoạt động'}"></span>
                                        </td>
                                        <td th:text="${#temporals.format(item.updatedAt, 'dd/MM/yyyy HH:mm')}"></td>
                                        <td class="text-center">
                                            <!-- Edit button, populates the modal with item data using `data-` attributes -->
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                                                th:data-id="${item.id}" th:data-name="${item.name}"
                                                th:data-price="${item.price}" th:data-vat-rate="${item.vatRate}"
                                                th:data-warranty-days="${item.warrantyDays}"
                                                th:data-active="${item.active}" title="Chỉnh sửa">
                                                <i class="fas fa-edit me-1"></i>Sửa
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Empty State: Message displayed when no service items are found. -->
                        <div th:unless="${serviceItems.totalElements > 0}" class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Không có dịch vụ nào</h5>
                            <p class="text-muted mb-4">
                                <span th:if="${search != null and !search.trim().isEmpty()}">
                                    Không tìm thấy dịch vụ nào với từ khóa "<strong th:text="${search}"></strong>"
                                </span>
                                <span th:unless="${search != null and !search.trim().isEmpty()}">
                                    Chưa có dịch vụ nào được tạo. Hãy thêm dịch vụ mới để bắt đầu.
                                </span>
                            </p>
                            <!-- Button to add a new service item, opens the modal -->
                            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                                data-bs-target="#serviceItemModal">
                                <i class="fas fa-plus me-2"></i>Thêm dịch vụ mới
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pagination: Navigation for browsing through multiple pages of service items. -->
                <nav aria-label="Page navigation" th:if="${serviceItems.totalPages > 0}" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <!-- "Previous" page link -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link"
                                th:href="@{/staff/service-items(page=${currentPage - 1}, size=10, search=${search}, activeOnly=${activeOnly})}"
                                th:if="${currentPage > 0}">Trước</a>
                            <span class="page-link" th:if="${currentPage == 0}">Trước</span>
                        </li>
                        <!-- "Next" page link -->
                        <li class="page-item"
                            th:classappend="${currentPage >= serviceItems.totalPages - 1} ? 'disabled'">
                            <a class="page-link"
                                th:href="@{/staff/service-items(page=${currentPage + 1}, size=10, search=${search}, activeOnly=${activeOnly})}"
                                th:if="${currentPage < serviceItems.totalPages - 1}">Sau</a>
                            <span class="page-link" th:if="${currentPage >= serviceItems.totalPages - 1}">Sau</span>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </main>

    <!--
        Service Item Modal: A Bootstrap modal used for adding new service items or editing existing ones.
        Its content is dynamically populated by JavaScript.
    -->
    <div class="modal fade" id="serviceItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceItemModalTitle">Thêm dịch vụ mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Form for service item creation/editing -->
                    <form id="serviceItemForm" th:action="@{/staff/service-items/create}" method="post">
                        <!-- Hidden input for service item ID (used for editing) -->
                        <input type="hidden" id="serviceItemId" name="id" />
                        <div class="mb-3">
                            <label for="name" class="form-label">Tên dịch vụ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Giá <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="price" name="price" min="0" step="1" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="vatRate" class="form-label">Thuế VAT <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="vatRate" name="vatRate" min="0" max="1"
                                step="0.001" required>
                            <div class="form-text">Nhập dạng thập phân (ví dụ: 0.085 = 8.5%)</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="warrantyDays" class="form-label">Bảo hành (ngày) <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="warrantyDays" name="warrantyDays" min="0"
                                required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="active" name="active" value="true">
                                <label class="form-check-label" for="active">
                                    Hoạt động
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-outline-primary" form="serviceItemForm">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!--
        CSV Import Modal: A Bootstrap modal for uploading a CSV file to import service items.
    -->
    <div class="modal fade" id="csvImportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/staff/service-items/import}" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Chọn file CSV</label>
                            <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                            <div class="form-text">Chỉ chấp nhận file .csv</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-outline-primary">Import</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:insert="~{fragments/footer :: footer}"></div>
    <script src="/js/service-items.js"></script>

</body>

</html>