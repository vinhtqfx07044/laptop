<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi" xml:lang="vi">

<head th:replace="~{fragments/head :: commonHead('Chi tiết Yêu cầu', false)}"></head>

<body class="d-flex flex-column min-vh-100">
    <div th:insert="~{fragments/header :: header}"></div>

    <main class="container flex-grow-1 mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Header with ID and timestamps -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-1">Chi tiết Yêu cầu</h1>
                    </div>
                    <div th:if="${isStaff}">
                        <!-- Show edit button if status is null -->
                        <a th:if="${request.status == null}" th:href="@{/staff/requests/edit/{id}(id=${request.id})}"
                            class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>Chỉnh sửa
                        </a>
                        <!-- Show edit button if status is not CANCELLED -->
                        <a th:if="${request.status != null and request.status.name() != 'CANCELLED'}"
                            th:href="@{/staff/requests/edit/{id}(id=${request.id})}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>Chỉnh sửa
                        </a>
                        <!-- Show lock button only if status is CANCELLED -->
                        <button th:if="${request.status != null and request.status.name() == 'CANCELLED'}"
                            class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-lock me-2"></i>Đã khóa
                        </button>
                    </div>
                </div>

                <!-- Include request info cards fragment -->
                <div th:insert="~{fragments/request-info :: requestInfoCards(${request}, false, ${isStaff})}"></div>

                <!-- Service Items and Total Card -->
                <div class="card mb-4" th:if="${request.items != null and !request.items.empty}">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Hạng mục sửa chữa</h5>
                    </div>
                    <div class="card-body">
                        <!-- Locked warning message -->
                        <div th:if="${request.status != null and request.status.isRequestItemsLocked}"
                            class="alert alert-warning mb-3">
                            <i class="fas fa-lock me-2"></i>
                            Phiếu đã được khóa - Không thể chỉnh sửa hạng mục
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Tên dịch vụ</th>
                                        <th>Số lượng</th>
                                        <th>Giá gốc</th>
                                        <th>Giảm giá</th>
                                        <th>VAT</th>
                                        <th>Thành tiền</th>
                                        <th>Số ngày bảo hành</th>
                                        <th>Ngày hết hạn bảo hành</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="item : ${request.items}">
                                        <td th:text="${item.name}"></td>
                                        <td th:text="${item.quantity}"></td>
                                        <td>
                                            <span class="currency-format" th:data-amount="${item.price}"></span>
                                        </td>
                                        <td>
                                            <span class="currency-format" th:data-amount="${item.discount}"></span>
                                        </td>
                                        <td th:text="${(item.vatRate * 100)} + '%'"></td>
                                        <td>
                                            <span class="currency-format" th:data-amount="${item.lineTotal}"></span>
                                        </td>
                                        <td th:text="${item.warrantyDays ?: 0}"></td>
                                        <td
                                            th:text="${(item.warrantyDays ?: 0) > 0 and request.status != null and request.status.name() == 'COMPLETED' and request.completedAt != null ? #temporals.format(request.completedAt.toLocalDate().plusDays(item.warrantyDays), 'dd/MM/yyyy') : 'Chưa áp dụng'}">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Total directly below table -->
                        <div class="row mt-3">
                            <div class="col-md-4 ms-auto">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold">Tổng cộng:</span>
                                            <h4 class="text-primary mb-0">
                                                <span class="currency-format" th:data-amount="${request.getTotal()}">0
                                                    ₫</span>
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Images Card -->
                <div class="card mb-4" th:if="${request.images != null and !request.images.empty}">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Hình ảnh</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div th:each="image : ${request.images}" class="col-md-3 mb-2">
                                <div class="card">
                                    <button type="button" class="btn p-0"
                                        th:onclick="'showImageModal(\'' + @{'/images/' + ${request.id} + '/' + ${image.filename}} + '\')'">
                                        <img th:src="@{'/images/' + ${request.id} + '/' + ${image.filename}}"
                                            class="card-img-top" style="height: 150px; object-fit: cover;"
                                            th:alt="${'Hình ảnh ' + image.filename}" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Accordion -->
                <div class="accordion mb-4" id="historyAccordion"
                    th:if="${request.history != null and !request.history.empty}">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
                                <i class="fas fa-history me-2"></i>
                                <strong>Lịch sử thay đổi</strong>
                                <span class="badge bg-secondary ms-2" th:text="${#lists.size(request.history)}"></span>
                            </button>
                        </h2>
                        <div id="historyCollapse" class="accordion-collapse collapse"
                            data-bs-parent="#historyAccordion">
                            <div class="accordion-body">
                                <div th:each="hist : ${request.history}" class="border-bottom pb-2 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted fw-bold"
                                            th:text="${#temporals.format(hist.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                                        <small class="text-muted" th:text="${hist.createdBy}"></small>
                                    </div>
                                    <div th:text="${hist.changes}" style="white-space: pre-wrap;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="mb-3">
                    <div th:if="${isStaff}">
                        <!-- Show edit button if status is null -->
                        <a th:if="${request.status == null}" th:href="@{/staff/requests/edit/{id}(id=${request.id})}"
                            class="btn btn-outline-primary">
                            <i class="fas fa-edit"></i> Chỉnh sửa
                        </a>
                        <!-- Show edit button if status is not CANCELLED -->
                        <a th:if="${request.status != null and request.status.name() != 'CANCELLED'}"
                            th:href="@{/staff/requests/edit/{id}(id=${request.id})}" class="btn btn-outline-primary">
                            <i class="fas fa-edit"></i> Chỉnh sửa
                        </a>
                        <!-- Show lock button only if status is CANCELLED -->
                        <button th:if="${request.status != null and request.status.name() == 'CANCELLED'}"
                            class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-lock"></i> Đã khóa
                        </button>
                        <a th:href="@{/staff/requests/list}" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-list"></i> Danh sách
                        </a>
                    </div>
                    <div th:unless="${isStaff}">
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-home"></i> Quay lại trang chủ
                        </a>
                    </div>
                </div>

                <!-- Image Modal -->
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Hình ảnh</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="modalImage" class="img-fluid" alt="Hình ảnh xem trước" />
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function showImageModal(src) {
                        document.getElementById('modalImage').src = src;
                        new bootstrap.Modal(document.getElementById('imageModal')).show();
                    }
                </script>
            </div>
        </div>
    </main>

    <div th:insert="~{fragments/footer :: footer}"></div>
    <!-- Chatbot widget removed - only for public pages -->
</body>

</html>